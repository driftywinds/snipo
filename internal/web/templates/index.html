{{define "content"}}
<div class="app-container" x-data="snippetsApp()">
    <!-- Sidebar -->
    <aside class="sidebar" :class="{ 'open': $store.app.sidebarOpen }">
        <a href="/" class="sidebar-header" title="Go to Home">
            <svg class="logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="16 18 22 12 16 6"></polyline>
                <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
            <h1>Snipo</h1>
        </a>
        
        <nav class="sidebar-nav">
            <!-- Quick actions -->
            <div class="sidebar-section">
                <div class="sidebar-item" @click="clearFilters()" :class="{ 'active': !filter.tagId && !filter.folderId && !filter.isFavorite }">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>All Snippets</span>
                    <span class="sidebar-item-count" x-text="totalSnippets"></span>
                </div>
                <div class="sidebar-item favorites-item" @click="showFavorites()" :class="{ 'active': filter.isFavorite }">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="star-icon">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    <span>Favorites</span>
                    <span class="sidebar-item-count" x-text="favoritesCount"></span>
                </div>
            </div>
            
            <!-- Folders -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" @click="foldersCollapsed = !foldersCollapsed">
                    <svg class="collapse-icon" :class="{ 'collapsed': foldersCollapsed }" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    <span class="sidebar-section-title">Folders</span>
                    <button class="sidebar-add-btn" @click.stop="showNewFolderModal()" title="New Folder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
                <div class="sidebar-section-content" x-show="!foldersCollapsed" x-collapse>
                    <template x-for="folder in folders" :key="folder.id">
                        <div>
                            <div class="sidebar-item folder-item" 
                                 :class="{ 'active': filter.folderId === folder.id }">
                                <div class="sidebar-item-main" @click="filterByFolder(folder.id)" :title="folder.name">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    <span x-text="folder.name"></span>
                                    <span class="sidebar-item-count" x-text="folder.snippet_count || 0"></span>
                                </div>
                                <div class="sidebar-item-actions">
                                    <button @click.stop="renameFolder(folder)" title="Rename">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button @click.stop="deleteFolder(folder)" title="Delete">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <!-- Nested folders -->
                            <template x-for="child in folder.children || []" :key="child.id">
                                <div class="sidebar-item folder-item nested"
                                     :class="{ 'active': filter.folderId === child.id }">
                                    <div class="sidebar-item-main" @click="filterByFolder(child.id)" :title="child.name">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        <span x-text="child.name"></span>
                                        <span class="sidebar-item-count" x-text="child.snippet_count || 0"></span>
                                    </div>
                                    <div class="sidebar-item-actions">
                                        <button @click.stop="renameFolder(child)" title="Rename">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                        <button @click.stop="deleteFolder(child)" title="Delete">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Tags -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" @click="tagsCollapsed = !tagsCollapsed">
                    <svg class="collapse-icon" :class="{ 'collapsed': tagsCollapsed }" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    <span class="sidebar-section-title">Tags</span>
                </div>
                <div class="sidebar-section-content" x-show="!tagsCollapsed" x-collapse>
                    <template x-for="tag in tags" :key="tag.id">
                        <div class="sidebar-item" 
                             :class="{ 'active': filter.tagId === tag.id }">
                            <div class="sidebar-item-main" @click="filterByTag(tag.id)" :title="tag.name">
                                <span class="tag-dot" :style="{ background: tag.color }"></span>
                                <span x-text="tag.name"></span>
                                <span class="sidebar-item-count" x-text="tag.snippet_count || 0"></span>
                            </div>
                            <div class="sidebar-item-actions">
                                <button @click.stop="renameTag(tag)" title="Rename">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button @click.stop="deleteTag(tag)" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </nav>
        
        <!-- Sidebar footer -->
        <div style="padding: 1rem; border-top: 1px solid var(--sidebar-border);">
            <div class="sidebar-item" @click="logout()" style="color: var(--snipo-danger); cursor: pointer;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Logout</span>
            </div>
        </div>
    </aside>
    
    <!-- Main content -->
    <main class="main-content">
        <!-- Header -->
        <header class="main-header">
            <!-- Mobile menu toggle -->
            <button class="btn-icon" @click="$store.app.toggleSidebar()" style="display: none;" id="menu-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            
            <!-- Search -->
            <div class="search-container">
                <input 
                    type="search" 
                    class="search-input" 
                    placeholder="Search snippets... (Ctrl+K)"
                    x-model="filter.query"
                    @input.debounce.300ms="search()"
                >
            </div>
            
            <!-- Left actions (New snippet) -->
            <div class="header-actions">
                <button class="btn-icon btn-primary" @click="newSnippet()" title="New Snippet (Ctrl+N)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Right actions (View toggle, Settings, Theme toggle) -->
            <div class="header-actions-right">
                <!-- View toggle -->
                <div class="view-toggle">
                    <button class="btn-icon" :class="{ 'active': viewMode === 'grid' }" @click="setViewMode('grid')" title="Grid View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                    <button class="btn-icon" :class="{ 'active': viewMode === 'list' }" @click="setViewMode('list')" title="List View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <!-- Settings -->
                <button class="btn-icon" @click="openSettings()" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
                
                <!-- Theme toggle -->
                <button class="btn-icon" @click="$store.app.toggleTheme()" title="Toggle theme">
                    <!-- Sun icon (shown in dark mode) -->
                    <svg x-show="$store.app.darkMode" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <!-- Moon icon (shown in light mode) -->
                    <svg x-show="!$store.app.darkMode" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </header>
        
        <!-- Draft recovery banner (supports multiple drafts) -->
        <div class="draft-banner" x-show="showDraftList && drafts.length > 0" x-cloak>
            <div class="draft-banner-content">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <span>You have <span x-text="drafts.length"></span> unsaved draft<span x-show="drafts.length > 1">s</span></span>
            </div>
            <div class="draft-list">
                <template x-for="draft in drafts" :key="draft.id">
                    <div class="draft-item">
                        <div class="draft-item-info">
                            <span class="draft-item-title" x-text="getDraftTitle(draft)"></span>
                            <span class="draft-item-time" x-text="new Date(draft.savedAt).toLocaleString()"></span>
                        </div>
                        <div class="draft-item-actions">
                            <button class="btn-secondary btn-sm" @click="discardDraft(draft)">Discard</button>
                            <button class="btn-primary btn-sm" @click="restoreDraft(draft)">Restore</button>
                        </div>
                    </div>
                </template>
            </div>
            <div class="draft-banner-actions" x-show="drafts.length > 1">
                <button class="btn-secondary" @click="discardAllDrafts()">Discard All</button>
            </div>
        </div>
        
        <!-- Content area -->
        <div class="snippet-list" x-show="!showEditor">
            <!-- Loading state -->
            <div class="loading" x-show="loading">
                <div class="spinner"></div>
            </div>
            
            <!-- Empty state -->
            <div class="empty-state" x-show="!loading && snippets.length === 0">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="16 18 22 12 16 6"></polyline>
                    <polyline points="8 6 2 12 8 18"></polyline>
                </svg>
                <h3>No snippets yet</h3>
                <p>Create your first snippet to get started</p>
                <button class="btn-primary mt-4" @click="newSnippet()">
                    Create Snippet
                </button>
            </div>
            
            <!-- Snippet grid/list -->
            <div :class="viewMode === 'list' ? 'snippet-list-view' : 'snippet-grid'" x-show="!loading && snippets.length > 0">
                <template x-for="snippet in snippets" :key="snippet.id">
                    <article class="snippet-card" @click="viewSnippet(snippet)">
                        <div class="snippet-card-header">
                            <h3 class="snippet-card-title" x-text="snippet.title"></h3>
                            <span class="snippet-card-language" 
                                  :style="{ background: getLanguageColor(snippet.language) }"
                                  x-text="snippet.language"></span>
                        </div>
                        
                        <!-- Show description if exists, otherwise show first 2 lines of code -->
                        <p class="snippet-card-description" x-show="snippet.description" x-text="snippet.description"></p>
                        <pre class="snippet-card-preview" x-show="!snippet.description"><code x-text="snippet.content.split('\n').slice(0, 2).join('\n')"></code></pre>
                        
                        <div class="snippet-card-footer">
                            <div class="snippet-card-tags">
                                <template x-for="tag in (snippet.tags || []).slice(0, 3)" :key="tag.id">
                                    <span class="tag">
                                        <span class="tag-dot" :style="{ background: tag.color }"></span>
                                        <span x-text="tag.name"></span>
                                    </span>
                                </template>
                            </div>
                            <div class="snippet-card-meta">
                                <span x-show="snippet.is_favorite" title="Favorite">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </span>
                                <span x-show="snippet.is_public" title="Public">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="2" y1="12" x2="22" y2="12"></line>
                                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                    </svg>
                                </span>
                                <span x-text="formatDate(snippet.updated_at)"></span>
                            </div>
                        </div>
                    </article>
                </template>
            </div>
            
            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4" x-show="pagination.totalPages > 1">
                <button 
                    @click="pagination.page--; loadSnippets()"
                    :disabled="pagination.page <= 1"
                    class="btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <span class="text-sm text-muted">
                    Page <span x-text="pagination.page"></span> of <span x-text="pagination.totalPages"></span>
                </span>
                <button 
                    @click="pagination.page++; loadSnippets()"
                    :disabled="pagination.page >= pagination.totalPages"
                    class="btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Snippet View/Editor -->
        <div class="editor-container" x-show="showEditor" x-cloak>
            <!-- Toolbar -->
            <div class="editor-toolbar">
                <button class="btn-icon" @click="cancelEdit()" title="Back">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                </button>
                
                <!-- Preview mode: show title as text -->
                <h2 class="editor-title-display" x-show="!isEditing" x-text="editingSnippet.title || 'Untitled'"></h2>
                
                <!-- Edit mode: show title input -->
                <input 
                    x-show="isEditing"
                    type="text" 
                    class="editor-title-input"
                    x-model="editingSnippet.title"
                    placeholder="Snippet title..."
                    @input="scheduleAutoSave()"
                >
                
                <div class="flex gap-2">
                    <button class="btn-icon" @click="toggleFavorite(editingSnippet)" x-show="editingSnippet?.id" title="Toggle Favorite">
                        <svg viewBox="0 0 24 24" :fill="editingSnippet?.is_favorite ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                    </button>
                    <button class="btn-icon" @click="copyToClipboard(editingSnippet)" title="Copy Code">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                    <button class="btn-icon" @click="copyShareLink(editingSnippet)" x-show="editingSnippet?.id && editingSnippet?.is_public" title="Copy Share Link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                    </button>
                    <button class="btn-icon" @click="confirmDelete(editingSnippet)" x-show="editingSnippet?.id" title="Delete">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                    
                    <!-- Edit button (preview mode) -->
                    <button class="btn-primary" x-show="!isEditing" @click="startEditing()" style="padding: 0.5rem 1rem;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right: 0.25rem;">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Edit
                    </button>
                    
                    <!-- Save button (edit mode) -->
                    <button class="btn-primary" x-show="isEditing" @click="saveSnippet()" style="padding: 0.5rem 1rem;">
                        Save
                    </button>
                </div>
            </div>
            
            <!-- PREVIEW MODE: Full-width code preview with metadata -->
            <div class="preview-mode" x-show="!isEditing">
                <!-- Metadata bar -->
                <div class="preview-metadata">
                    <div class="preview-meta-item" x-show="editingSnippet.description">
                        <span class="preview-meta-label">Description</span>
                        <span x-text="editingSnippet.description"></span>
                    </div>
                    <div class="preview-meta-item">
                        <span class="preview-meta-label">Language</span>
                        <span class="language-badge" :style="{ background: getLanguageColor(editingSnippet.language) }" x-text="editingSnippet.language"></span>
                    </div>
                    <div class="preview-meta-item" x-show="editingSnippet.folder_id">
                        <span class="preview-meta-label">Folder</span>
                        <a href="#" class="folder-link" @click.prevent="filterByFolder(editingSnippet.folder_id)" x-text="flattenedFolders.find(f => f.id == editingSnippet.folder_id)?.name || ''"></a>
                    </div>
                    <div class="preview-meta-item" x-show="editingSnippet.tags?.length > 0">
                        <span class="preview-meta-label">Tags</span>
                        <div class="preview-tags">
                            <template x-for="tag in editingSnippet.tags" :key="tag">
                                <span class="tag-badge" x-text="tag"></span>
                            </template>
                        </div>
                    </div>
                    <div class="preview-meta-item" x-show="editingSnippet.is_public">
                        <span class="tag-badge public-badge">Public</span>
                    </div>
                </div>
                
                <!-- Full code preview -->
                <div class="preview-code">
                    <pre><code :class="'language-' + editingSnippet.language" x-text="editingSnippet.content"></code></pre>
                </div>
            </div>
            
            <!-- EDIT MODE: Split view with editor left, preview right, sidebar for metadata -->
            <div class="edit-mode" x-show="isEditing">
                <!-- Top metadata bar (description, language, folder, public) -->
                <div class="editor-metadata">
                    <div class="editor-field-inline" style="flex: 1;">
                        <label>Description</label>
                        <input 
                            type="text"
                            x-model="editingSnippet.description"
                            placeholder="Optional description..."
                        >
                    </div>
                    
                    <div class="editor-field-inline compact">
                        <label>Language</label>
                        <select x-model="editingSnippet.language" @change="$nextTick(() => highlightAll())">
                            <option value="javascript">JavaScript</option>
                            <option value="typescript">TypeScript</option>
                            <option value="python">Python</option>
                            <option value="go">Go</option>
                            <option value="rust">Rust</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="cpp">C++</option>
                            <option value="ruby">Ruby</option>
                            <option value="php">PHP</option>
                            <option value="swift">Swift</option>
                            <option value="kotlin">Kotlin</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="sql">SQL</option>
                            <option value="bash">Bash</option>
                            <option value="json">JSON</option>
                            <option value="yaml">YAML</option>
                            <option value="markdown">Markdown</option>
                            <option value="plaintext">Plain Text</option>
                        </select>
                    </div>
                    
                    <div class="editor-field-inline compact">
                        <label>Folder</label>
                        <select x-model="editingSnippet.folder_id">
                            <option value="">No folder</option>
                            <template x-for="folder in flattenedFolders" :key="folder.id">
                                <option :value="folder.id" x-text="folder.displayName"></option>
                            </template>
                        </select>
                    </div>
                    
                    <label class="public-toggle">
                        <input type="checkbox" x-model="editingSnippet.is_public">
                        <span>Public</span>
                    </label>
                </div>
                
                <!-- Main edit area: code split + tags sidebar -->
                <div class="editor-main-with-sidebar">
                    <!-- Code split (editor left, preview right) -->
                    <div class="code-split">
                        <textarea 
                            class="code-textarea"
                            x-model="editingSnippet.content"
                            placeholder="Paste your code here..."
                            spellcheck="false"
                            @input="$nextTick(() => highlightAll()); scheduleAutoSave()"
                        ></textarea>
                        <div class="code-preview">
                            <pre><code :class="'language-' + editingSnippet.language" x-text="editingSnippet.content"></code></pre>
                        </div>
                    </div>
                    
                    <!-- Tags sidebar (right) -->
                    <div class="tags-sidebar">
                        <div class="tags-sidebar-header">
                            <label>Tags</label>
                        </div>
                        
                        <!-- Current tags (vertical list) -->
                        <div class="tags-list">
                            <template x-for="(tag, index) in editingSnippet.tags" :key="index">
                                <div class="tag-list-item">
                                    <span x-text="tag"></span>
                                    <button @click="removeTag(index)" class="tag-remove-btn" title="Remove">Ã—</button>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Add new tag -->
                        <div class="tag-add-section">
                            <input 
                                type="text"
                                class="tag-add-input"
                                placeholder="Add tag..."
                                @keydown.enter.prevent="addTag($event.target.value); $event.target.value = ''"
                                list="existing-tags-edit"
                            >
                            <datalist id="existing-tags-edit">
                                <template x-for="tag in tags" :key="tag.id">
                                    <option :value="tag.name"></option>
                                </template>
                            </datalist>
                        </div>
                        
                        <!-- Existing tags to quickly add -->
                        <div class="tags-suggestions" x-show="tags.length > 0">
                            <label class="tags-suggestions-label">Quick add:</label>
                            <div class="tags-suggestions-list">
                                <template x-for="tag in tags.filter(t => !editingSnippet.tags.includes(t.name)).slice(0, 10)" :key="tag.id">
                                    <button class="tag-suggestion" @click="addTag(tag.name)" :title="tag.name">
                                        <span class="tag-dot" :style="{ background: tag.color }"></span>
                                        <span x-text="tag.name"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Delete confirmation modal -->
    <div class="modal-backdrop" x-show="showDeleteModal" x-cloak @click.self="showDeleteModal = false">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Snippet</h3>
                <button class="btn-icon" @click="showDeleteModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span x-text="deleteTarget?.title"></span>"?</p>
                <p class="text-sm text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button @click="showDeleteModal = false">Cancel</button>
                <button class="btn-primary" style="background: var(--snipo-danger); border-color: var(--snipo-danger);" @click="deleteSnippet()">
                    Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Settings modal -->
    <div class="modal-backdrop" x-show="showSettings" x-cloak @click.self="closeSettings()">
        <div class="modal settings-modal">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="btn-icon" @click="closeSettings()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Settings tabs -->
            <div class="settings-tabs">
                <button class="settings-tab" :class="{ active: settingsTab === 'password' }" @click="settingsTab = 'password'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Password
                </button>
                <button class="settings-tab" :class="{ active: settingsTab === 'apikeys' }" @click="settingsTab = 'apikeys'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                    </svg>
                    API Keys
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Password tab -->
                <div x-show="settingsTab === 'password'">
                    <form @submit.prevent="changePassword()">
                        <div class="editor-field">
                            <label>Current Password</label>
                            <input type="password" x-model="passwordForm.current" required>
                        </div>
                        <div class="editor-field">
                            <label>New Password</label>
                            <input type="password" x-model="passwordForm.new" required minlength="6">
                        </div>
                        <div class="editor-field">
                            <label>Confirm New Password</label>
                            <input type="password" x-model="passwordForm.confirm" required>
                        </div>
                        
                        <p x-show="passwordError" class="text-sm" style="color: var(--snipo-danger);" x-text="passwordError"></p>
                        <p x-show="passwordSuccess" class="text-sm" style="color: var(--snipo-success);" x-text="passwordSuccess"></p>
                        
                        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">
                            Change Password
                        </button>
                    </form>
                </div>
                
                <!-- API Keys tab -->
                <div x-show="settingsTab === 'apikeys'">
                    <!-- Create new token -->
                    <div class="api-token-form">
                        <h4 style="margin-bottom: 1rem;">Create New API Token</h4>
                        
                        <!-- Show created token -->
                        <div x-show="createdToken" class="created-token-box">
                            <p class="text-sm" style="margin-bottom: 0.5rem;"><strong>Token created!</strong> Copy it now - it won't be shown again.</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" :value="createdToken" readonly style="font-family: var(--font-mono); font-size: 0.8rem;">
                                <button class="btn-primary" @click="copyToken()" style="white-space: nowrap;">Copy</button>
                            </div>
                        </div>
                        
                        <div x-show="!createdToken">
                            <div class="editor-field">
                                <label>Token Name</label>
                                <input type="text" x-model="newToken.name" placeholder="e.g., CLI Access">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="editor-field">
                                    <label>Permissions</label>
                                    <select x-model="newToken.permissions">
                                        <option value="read">Read Only</option>
                                        <option value="write">Read & Write</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div class="editor-field">
                                    <label>Expires In (days)</label>
                                    <input type="number" x-model="newToken.expires_in_days" min="1" max="365" placeholder="30">
                                </div>
                            </div>
                            <button class="btn-primary" @click="createApiToken()" style="width: 100%;">
                                Create Token
                            </button>
                        </div>
                    </div>
                    
                    <!-- Existing tokens -->
                    <div class="api-tokens-list" style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Existing Tokens</h4>
                        
                        <div x-show="apiTokens.length === 0" class="text-sm text-muted">
                            No API tokens yet.
                        </div>
                        
                        <template x-for="token in apiTokens" :key="token.id">
                            <div class="api-token-item">
                                <div class="api-token-info">
                                    <div class="api-token-name" x-text="token.name"></div>
                                    <div class="api-token-meta">
                                        <span class="api-token-permission" x-text="token.permissions"></span>
                                        <span>Created: <span x-text="formatTokenDate(token.created_at)"></span></span>
                                        <span x-show="token.expires_at">Expires: <span x-text="formatTokenDate(token.expires_at)"></span></span>
                                        <span x-show="token.last_used_at">Last used: <span x-text="formatTokenDate(token.last_used_at)"></span></span>
                                    </div>
                                </div>
                                <button class="btn-icon danger" @click="deleteApiToken(token.id)" title="Delete token">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Folder modal -->
    <div class="modal-backdrop" x-show="showFolderModal" x-cloak @click.self="showFolderModal = false">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 x-text="editingFolder?.id ? 'Rename Folder' : 'New Folder'"></h3>
                <button class="btn-icon" @click="showFolderModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="editor-field">
                    <label>Folder Name</label>
                    <input type="text" x-model="editingFolder.name" @keydown.enter="saveFolder()" autofocus>
                </div>
                <div class="editor-field" x-show="!editingFolder?.id">
                    <label>Parent Folder (optional)</label>
                    <select x-model="editingFolder.parent_id">
                        <option value="">No parent</option>
                        <template x-for="folder in folders" :key="folder.id">
                            <option :value="folder.id" x-text="folder.name"></option>
                        </template>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button @click="showFolderModal = false">Cancel</button>
                <button class="btn-primary" @click="saveFolder()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Rename Tag modal -->
    <div class="modal-backdrop" x-show="showTagModal" x-cloak @click.self="showTagModal = false">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Rename Tag</h3>
                <button class="btn-icon" @click="showTagModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="editor-field">
                    <label>Tag Name</label>
                    <input type="text" x-model="editingTag.name" @keydown.enter="saveTag()" autofocus>
                </div>
            </div>
            <div class="modal-footer">
                <button @click="showTagModal = false">Cancel</button>
                <button class="btn-primary" @click="saveTag()">Save</button>
            </div>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }
    
    @media (max-width: 768px) {
        #menu-toggle { display: flex !important; }
    }
</style>
{{end}}
